---
title: "Manuscript Tables and Figures"
format:
  docx:
    reference-doc: ref.docx
    fig-cap-location: top
execute:
  echo: false
  message: false
  warning: false
---


```{r}
library(CohortCharacteristics)
library(dplyr)
library(ggplot2)
library(IncidencePrevalence)
library(markdown)
library(omopgenerics)
library(OmopSketch)
library(tidyr)
library(visOmopResults)
library(CohortSurvival)
library(flextable)
library(lme4)
library(broom)     
library(glmmTMB)
library(purrr)
library(patchwork)
library(ggh4x)

# whether to run meta analysis
runMetaAnalysis <- FALSE

# preprocess data if it has not been done
fileData <- file.path(getwd(), "data", "shinyData.RData")
if (!file.exists(fileData)) {
  source(file.path(getwd(), "data", "preprocess.R"))
}

# load shiny data
load(fileData)

# source functions
source(file.path(getwd(), "functions.R"))

# Quarto options
knitr::opts_chunk$set(
  out.width  = "95%",  # figures occupy ~95% of document width
  out.height = "auto",
  dpi        = 320,    # ensure figure quality
  fig.width  = 9,      # default aspect ratio (can be overridden per-figure)
  fig.height = 6,
  results    = "asis"  # enable Markdown produced via cat() inside chunks
)

maeCode <- c("miscarriage", "stillbirth", "preterm_labour", "dysfunctional_labour", "antepartum_haemorrhage",  "gestational_diabetes", "preeclampsia", "eclampsia", "hellp", "ectopic_pregnancy", "postpartum_endometritis", "postpartum_haemorrhage", "maternal_death")
maeClean <- c("Miscarriage", "Ectopic pregnancy", "Stillbirth", "Preterm labour", "Dysfunctional labour", "Antepartum haemorrhage",  "Gestational diabetes", "Pre-eclampsia", "Eclampsia", "HELLP", "Postpartum endometritis", "Postpartum haemorrhage", "Maternal death")
aesiCode <- c("deep_vein_thrombosis", "pulmonary_embolism", "bells_palsy", "immune_thrombocytopenia", "anaphylaxis", "myocarditis_or_pericarditis", "ischaemic_stroke", "haemorrhagic_stroke", "tts",  "guillain_barre_syndrome",  "disseminated_intravascular_coagulation", "transverse_myelitis", "narcolepsy", "myocardial_infarction", "encephalitis")
aesiClean <- c('Deep vein thrombosis', 'Pulmonary embolism', 'Bell‚Äôs palsy', 'Immune thrombocytopenia', 'Anaphylaxis', 'Myocarditis or pericarditis', 'Ischaemic stroke', 'Haemorrhagic stroke', 'Thrombosis with thrombocytopenia syndrome', 'Guillain‚ÄìBarr√© syndrome', 'Disseminated intravascular coagulation', 'Transverse myelitis', 'Narcolepsy', 'Myocardial infarction', 'Encephalitis')
excludeCPRD <- c("Miscarriage", "Stillbirth")
dbOrder <- c("NLHR@UiO", "SCIFI-PEARL", "SIDIAP", "CPRD GOLD")

setGlobalTableOptions(type = "flextable")
```

:::{custom-style="Caption"}
Table 1. Characteristics of included pregnancies, stratified by database. 

:::

```{r}
# prepare results ----
data$summarise_characteristics |>
  dplyr::filter(group_level == "pregnancy_denominator", strata_name == "overall") |>
  dplyr::filter(
    !variable_name %in% c("Cohort start date", "Cohort end date", "Age", "Sex", "Prior observation", "Future observation")
  ) |>
  dplyr::mutate(
    estimate_value = if_else(variable_name == "Previous pregnancies", as.character(as.numeric(.data$estimate_value) - 1), .data$estimate_value),
    cdm_name = factor(cdm_name, levels = dbOrder),
    variable_level = dplyr::if_else(variable_name == "Previous pregnancies", "-", variable_level),
    variable_name = factor(
      variable_name,
      levels = c(
        "Number records", 
        "Maternal age", 
        "Maternal age group",
        "Days in cohort", 
        "Previous pregnancies", 
        "Covariates in the past 5 years",
        "History of comorbidities", 
        "Medications in the past year"
      ),
      labels = c(
        "Number pregnancies", 
        "Maternal age", 
        "Maternal age group",
        "Pregnancy length", 
        "Previous pregnancies",
        "Covariates (previous 5 years)",
        "Comorbidities (any-time before)",
        "Medications (previous year)"
      )
    ),
    variable_level = factor(
      variable_level,
      levels = c(
        "12 to 17", "18 to 34", "35 to 55", "-", 
        
        "Obesity", "Depression", "Anxiety", "Alcohol misuse dependence", 
        
        "Asthma", "Diabetes", "Thyroid disorder", 
        "Essential hypertension", 
        "Systemic lupus erythematosus", "Hiv", 
        
        "Antidepressants", "Antiinflammatory antirheumatic", "Nsaids", 
        "Opioids", "Treatment acid related disorder", "Antiepileptics", 
        "Diabetes treatments"
      ),
      labels = c(
        "12 to 17", "18 to 34", "35 to 55", "-", 
        
        "Obesity", "Depression", "Anxiety", "Alcohol misuse dependence", 
        
        "Asthma", "Diabetes", "Thyroid disorder", 
        "Essential hypertension", 
        "SLE", "HIV", 
        
        "Antidepressants", "Antiinflammatory antirheumatic", "NSAIDs", 
        "Opioids", "Acid-related disorder treatments", "Antiepileptics", 
        "Diabetes treatments"
      )
    )
  ) |>
  dplyr::filter(!is.na(variable_name)) |>
  dplyr::arrange(cdm_name, variable_name, variable_level) |>
  visOmopTable(
    estimateName = c(
      "N (%)" = "<count> (<percentage>%)",
      "N" = "<count>",
      "Median [Q25 to Q75]" = "<median> [<q25> to <q75>]"
    ),
    rename = c("Database" = "cdm_name"),
    header = "cdm_name",
    hide = c("cohort_name", strataColumns(data$summarise_characteristics)),
    .options = list(keepNotFormatted = FALSE, groupAsColumn = TRUE),
    groupColumn = "variable_name"
  ) |>
  set_table_properties(width = 1, layout = "autofit") |>
  font(fontname = "calibri", part = "all") |>
  fontsize(size = 9, part = "body") |>
  fontsize(size = 10, part = "header") |>
  width(j = 1, width = 2.3, unit = "cm") |>
  width(j = 1:3, width = 2.66, unit = "cm") |>
  width(j = 1:3, width = 2.3, unit = "cm")
```

:::{custom-style="FooterNuria"}
SLE = Systemic Lupus Erythematosus; HIV = Human Immunodeficiency Virus; NSAIDs = Nonsteroidal Anti-Inflammatory Drugs
:::





:::{custom-style="Caption"}
Table 2. Pooled Incidence Rates (per 100,000 person-years) and 95% Prediction Intervals for adverse events across four databases.

:::

```{r}
# prepare results ----
tidyIncidence <- data$incidence |>
  dplyr::filter(strata_name %in% c("overall", "gestational_trimester", "maternal_age_group", "pregnancy_start_period")) |>
  omopgenerics::filterAdditional(outcome_group %in% c("Maternal Adverse Events", "Adverse Events of Special Interest")) |>
  dplyr::mutate(
    group_level = factor(
      .data$group_level, 
      levels = c(aesiCode, maeCode), 
      labels = c(aesiClean, maeClean)
    ),
    group_level = as.character(group_level)
  ) |>
  dplyr::filter(!is.na(group_level)) |>
  dplyr::filter(!(cdm_name == "CPRD GOLD" & group_level %in% excludeCPRD)) |>
  tidy() |>
  select(!c(
    "socioeconomic_status", "ethnicity", "birth_continent", "nationallity", "variable_name", "variable_level", "person_days_count", "incidence_100000_pys", "incidence_100000_pys_95CI_lower", "incidence_100000_pys_95CI_upper", "outcome_in_period_count", "outcome_in_period_percentage"
  ))

# pool results ----
# --> model event counts using a Poisson distribution
# --> account for different amounts of person-time in each database
# --> random-effect for between-database heterogeneity. random intercept for database (1 | cdm_name)
# --> consider databases with zero events
if (runMetaAnalysis) {
  data$meta_incidence <- tidyIncidence |>
    filter(!is.na(outcome_count), !is.na(person_years)) |>
    group_by(
      outcome_cohort_name,
      gestational_trimester,
      maternal_age_group,
      pregnancy_start_period,
      outcome_group
    ) |>
    nest() |>
    mutate(
      meta = map(data, metaIR)
    ) |>
    unnest(meta) |>
    ungroup() |>
    select(!data)
  save(data, choices, selected, values, file = file.path(getwd(), "data", "shinyData.RData"))
} 

# display results ----
data$meta_incidence |>
  dplyr::filter(
    gestational_trimester == "overall",
    maternal_age_group == "overall",
    pregnancy_start_period == "overall"
  ) |>
  select(!c("gestational_trimester", "maternal_age_group", "pregnancy_start_period")) |>
  pivot_longer(
    cols = c("pooled_incidence_100000_pys", "predicted_interval_95CI_lower", "predicted_interval_95CI_upper", "tau2", "denominator_count", "outcome_count", "outcome_percentage", "number_of_databases", "person_years"),
    values_to = "estimate_value",
    names_to = "estimate_name"
  ) |>
  mutate(
    estimate_type = case_when(
      grepl("count", estimate_name) | estimate_name == "number_of_databases" ~ "integer",
      grepl("percentage", estimate_name) | estimate_name == "tau2" ~ "percentage",
      .default = "numeric"
    ),
    outcome = factor(.data$outcome_cohort_name, levels = c(aesiClean, maeClean)),
    estimate_value = as.character(estimate_value)
  ) |>
  filter(!is.na(outcome)) |>
  arrange(outcome) |>
  select(!"outcome_cohort_name") |>
  visTable(
    estimateName = c(
      "Databases (N)" = "<number_of_databases>",
      "Pregnancies (N)" = "<denominator_count>",
      "Outcomes (N (%))" = "<outcome_count> (<outcome_percentage>%)",
      "Person-Years" = "<person_years>",
      "IR (95% PI)" = "<pooled_incidence_100000_pys> (<predicted_interval_95CI_lower> to <predicted_interval_95CI_upper>)",
      "ùúè¬≤" = "<tau2>"
    ),
    hide = "estimate_type",
    header = "estimate_name",
    groupColumn = "outcome_group",
    .options = list(decimals = c(integer = 0, percentage = 3, numeric = 2))
  ) |>
  set_table_properties(width = 1, layout = "autofit") |>
  font(fontname = "calibri", part = "all") |>
  fontsize(size = 9, part = "body") |>
  fontsize(size = 10, part = "header")
```

:::{custom-style="FooterNuria"}
Pooled incidence rates were estimated per 100,000 person-years using Poisson generalized linear mixed models with a random intercept for database; 95% prediction intervals reflect between-database heterogeneity. Source-specific estimates are shown in Supplementary Table Sx. Databases with event counts <5 were clouded as per data-protection rules and were not included in pooled estimates. 
IR = Incidence Rate; PI = Prediction Interval; ùúè¬≤ = estimated in between-database variance
:::


:::{custom-style="Caption"}
Figure 1. Incidence rates per 100,000 person-years for the 6-most frequent Adverse Events of Special Interest among pregnant women, stratified by gestational trimester and database.
:::

```{r,  fig.height = 9}
# prepare results ----
tidyIncidence <- data$incidence |>
  dplyr::filter(strata_name %in% c("gestational_trimester", "maternal_age_group")) |>
  omopgenerics::filterAdditional(outcome_group %in% c("Adverse Events of Special Interest")) |>
  dplyr::mutate(
    group_level = factor(
      .data$group_level, 
      levels = c(aesiCode, maeCode), 
      labels = c(aesiClean, maeClean)
    ),
    group_level = as.character(group_level)
  ) |>
  dplyr::filter(!is.na(group_level)) |>
  dplyr::filter(!(cdm_name == "CPRD GOLD" & group_level %in% excludeCPRD)) |>
  tidy() |>
  select(!c(
    "socioeconomic_status", "ethnicity", "birth_continent", "nationallity", "variable_name", "variable_level", "person_days_count"
  )) |>
  filter(!outcome_cohort_name %in% c("Thrombosis with thrombocytopenia syndrome", "Narcolepsy", "Disseminated intravascular coagulation", "Encephalitis", "Guillain‚ÄìBarr√© syndrome", "Myocardial infarction", "Transverse myelitis", "Ischaemic stroke", "Haemorrhagic stroke")) |>
  mutate(
    outcome_cohort_name = factor(.data$outcome_cohort_name, levels = aesiClean),
    cdm_name = factor(cdm_name, dbOrder)
  ) |>
  arrange(cdm_name, outcome_cohort_name)

pTrimester <- pIncidence(tidyIncidence |> filter(maternal_age_group == "overall"), "gestational_trimester", "free_y") +
   ggh4x::facetted_pos_scales(
     y  = list(
       outcome_cohort_name == "Deep vein thrombosis" ~ scale_y_continuous(limits = c(0,170), oob = scales::rescale_none),
       outcome_cohort_name == "Pulmonary embolism" ~ scale_y_continuous(limits = c(0,250), oob = scales::rescale_none),
       outcome_cohort_name == "Bell‚Äôs palsy" ~ scale_y_continuous(limits = c(0,170), oob = scales::rescale_none),
       outcome_cohort_name == "Immune thrombocytopenia" ~ scale_y_continuous(limits = c(0,150), oob = scales::rescale_none),
       outcome_cohort_name == "Anaphylaxis" ~ scale_y_continuous(limits = c(0,50), oob = scales::rescale_none),
       outcome_cohort_name == "Myocarditis or pericarditis" ~ scale_y_continuous(limits = c(0,30), oob = scales::rescale_none)
     )
   ) +
  ggtitle("A) Incidence Rates by Gestational Trimester") +
  theme(title = element_text(face = "bold", size = 13))
pAge <- pIncidence(tidyIncidence |> filter(gestational_trimester == "overall"), "maternal_age_group", "free_y") +
  # scale_y_continuous(limits = c(0,150)) +
  theme(legend.position = "none") +
     ggh4x::facetted_pos_scales(
     y  = list(
       outcome_cohort_name == "Deep vein thrombosis" ~ scale_y_continuous(limits = c(0,150), oob = scales::rescale_none),
       outcome_cohort_name == "Pulmonary embolism" ~ scale_y_continuous(limits = c(0,250), oob = scales::rescale_none),
       outcome_cohort_name == "Bell‚Äôs palsy" ~ scale_y_continuous(limits = c(0,100), oob = scales::rescale_none),
       outcome_cohort_name == "Immune thrombocytopenia" ~ scale_y_continuous(limits = c(0,100), oob = scales::rescale_none),
       outcome_cohort_name == "Anaphylaxis" ~ scale_y_continuous(limits = c(0,40), oob = scales::rescale_none),
       outcome_cohort_name == "Myocarditis or pericarditis" ~ scale_y_continuous(limits = c(0,25), oob = scales::rescale_none)
     )
   ) +
  ggtitle("B) Incidence Rates by Age") +
  theme(title = element_text(face = "bold", size = 13))

pTrimester / pAge + 
  plot_layout(heights = c(2, 1.9)) 
```

```{r,  fig.height = 9}
# prepare results ----
tidyIncidence <- data$incidence |>
  dplyr::filter(strata_name %in% c("gestational_trimester", "maternal_age_group")) |>
  omopgenerics::filterAdditional(outcome_group %in% c("Adverse Events of Special Interest")) |>
  dplyr::mutate(
    group_level = factor(
      .data$group_level, 
      levels = c(aesiCode, maeCode), 
      labels = c(aesiClean, maeClean)
    ),
    group_level = as.character(group_level)
  ) |>
  dplyr::filter(!is.na(group_level)) |>
  dplyr::filter(!(cdm_name == "CPRD GOLD" & group_level %in% excludeCPRD)) |>
  tidy() |>
  select(!c(
    "socioeconomic_status", "ethnicity", "birth_continent", "nationallity", "variable_name", "variable_level", "person_days_count"
  )) |>
  filter(!outcome_cohort_name %in% c("Thrombosis with thrombocytopenia syndrome", "Narcolepsy", "Disseminated intravascular coagulation", "Encephalitis", "Guillain‚ÄìBarr√© syndrome", "Myocardial infarction", "Transverse myelitis", "Ischaemic stroke", "Haemorrhagic stroke")) |>
  mutate(
    outcome_cohort_name = factor(.data$outcome_cohort_name, levels = aesiClean),
    cdm_name = factor(cdm_name, dbOrder)
  ) |>
  arrange(cdm_name, outcome_cohort_name)

pTrimester <- pIncidence(tidyIncidence |> filter(maternal_age_group == "overall"), "gestational_trimester", "free_y", FALSE) +
   ggh4x::facetted_pos_scales(
     y  = list(
       outcome_cohort_name == "Deep vein thrombosis" ~ scale_y_continuous(limits = c(0,170), oob = scales::rescale_none),
       outcome_cohort_name == "Pulmonary embolism" ~ scale_y_continuous(limits = c(0,250), oob = scales::rescale_none),
       outcome_cohort_name == "Bell‚Äôs palsy" ~ scale_y_continuous(limits = c(0,170), oob = scales::rescale_none),
       outcome_cohort_name == "Immune thrombocytopenia" ~ scale_y_continuous(limits = c(0,150), oob = scales::rescale_none),
       outcome_cohort_name == "Anaphylaxis" ~ scale_y_continuous(limits = c(0,50), oob = scales::rescale_none),
       outcome_cohort_name == "Myocarditis or pericarditis" ~ scale_y_continuous(limits = c(0,30), oob = scales::rescale_none)
     )
   ) +
  ggtitle("A) Incidence Rates by Gestational Trimester") +
  theme(title = element_text(face = "bold", size = 13))
pAge <- pIncidence(tidyIncidence |> filter(gestational_trimester == "overall"), "maternal_age_group", "free_y", FALSE) +
  # scale_y_continuous(limits = c(0,150)) +
  theme(legend.position = "none") +
     ggh4x::facetted_pos_scales(
     y  = list(
       outcome_cohort_name == "Deep vein thrombosis" ~ scale_y_continuous(limits = c(0,150), oob = scales::rescale_none),
       outcome_cohort_name == "Pulmonary embolism" ~ scale_y_continuous(limits = c(0,250), oob = scales::rescale_none),
       outcome_cohort_name == "Bell‚Äôs palsy" ~ scale_y_continuous(limits = c(0,100), oob = scales::rescale_none),
       outcome_cohort_name == "Immune thrombocytopenia" ~ scale_y_continuous(limits = c(0,100), oob = scales::rescale_none),
       outcome_cohort_name == "Anaphylaxis" ~ scale_y_continuous(limits = c(0,40), oob = scales::rescale_none),
       outcome_cohort_name == "Myocarditis or pericarditis" ~ scale_y_continuous(limits = c(0,25), oob = scales::rescale_none)
     )
   ) +
  ggtitle("B) Incidence Rates by Age") +
  theme(title = element_text(face = "bold", size = 13))

pTrimester / pAge + 
  plot_layout(heights = c(2, 1.9)) 
```

:::{custom-style="Caption"}
Figure 2. Cumulative curves for Maternal Adverse Events across databases.
:::

```{r, fig.width=10}
survivalTidy <- data$survival |>
  dplyr::filter(strata_name %in% c("overall", "maternal_age_group")) |>
  asSurvivalResult() |>
  dplyr::mutate(
    outcome = factor(.data$outcome, levels = maeCode,  labels = maeClean),
    cdm_name = factor(cdm_name, dbOrder)
  ) |>
  dplyr::filter(!is.na(outcome)) |>
  dplyr::filter(!(cdm_name == "CPRD GOLD" & outcome %in% excludeCPRD)) |>
  select(!c(
    "socioeconomic_status", "ethnicity", "birth_continent", "nationallity", "competing_outcome"
  )) |>
  arrange(cdm_name, outcome)

colors <- c("#C94A5A", "#4A6FE3", "#4FAE6A", "#E08A3C")
survivalTidy |>
  filter(maternal_age_group == "overall") |>
  pSurvival() +
  geom_vline(data = filter(survivalTidy, !grepl("Postpartum", outcome) & maternal_age_group == "overall"), aes(xintercept = 90), colour = "#495057", linetype = "dashed") +
  geom_vline(data = filter(survivalTidy, !grepl("Postpartum", outcome) & maternal_age_group == "overall"), aes(xintercept = 180), colour = "#495057", linetype = "dashed") +
  facet_wrap(vars(outcome), nrow = 3, ncol = 5, scales = "free", labeller = label_wrap_gen(10)) +
  ggh4x::facetted_pos_scales(
    y  = list(
      outcome == "Ectopic pregnancy" ~ scale_y_continuous(limits = c(0,0.05), oob = scales::rescale_none),
      outcome == "Antepartum haemorrhage" ~ scale_y_continuous(limits = c(0,0.08), oob = scales::rescale_none),
      outcome == "Gestational diabetes" ~ scale_y_continuous(limits = c(0,0.1), oob = scales::rescale_none),
      outcome == "Pre-eclampsia" ~ scale_y_continuous(labels = scales::label_comma(), oob = scales::rescale_none),
      outcome == "Eclampsia"  ~ scale_y_continuous(limits = c(0,0.005), oob = scales::rescale_none)
    )
  )
```

:::{custom-style="Caption"}
Figure 3. Cumulative incidence curves for Maternal Adverse Events across databases, stratified by age.
:::

```{r, fig.height=14}
colors <- c("#C94A5A", "#4A6FE3", "#4FAE6A", "#E08A3C")
survivalTidyAge <- survivalTidy |>
  filter(maternal_age_group != "overall") |>
  mutate(maternal_age_group = as.character(maternal_age_group))
survivalTidyAge |>
  pSurvival() +
  geom_vline(data = filter(survivalTidyAge, !grepl("Postpartum", outcome)), aes(xintercept = 90), colour = "#495057", linetype = "dashed") +
  geom_vline(data = filter(survivalTidyAge, !grepl("Postpartum", outcome)), aes(xintercept = 180), colour = "#495057", linetype = "dashed") +
  facet_grid(rows = vars(outcome), cols = vars(maternal_age_group), scales = "free", labeller = label_wrap_gen(10)) +
  ggh4x::facetted_pos_scales(
    # x  = list(
    #   grepl("Postpartum", outcome) ~ scale_x_continuous(limits = c(0,84)),
    #   !grepl("Postpartum", outcome) ~ scale_x_continuous(limits = c(0,308))
    # ),
    y  = list(
      outcome == "Ectopic pregnancy" ~ scale_y_continuous(limits = c(0,0.03), oob = scales::rescale_none),
      outcome == "Antepartum haemorrhage" ~ scale_y_continuous(limits = c(0,0.05), oob = scales::rescale_none),
      outcome == "Gestational diabetes" ~ scale_y_continuous(limits = c(0,0.08), oob = scales::rescale_none),
      outcome == "Pre-eclampsia" ~ scale_y_continuous(limits = c(0,0.001), labels = scales::label_comma(), oob = scales::rescale_none),
      outcome == "Eclampsia" ~ scale_y_continuous(limits = c(0,0.003), oob = scales::rescale_none),
      outcome == "Postpartum endometritis" ~ scale_y_continuous(limits = c(0,0.006), oob = scales::rescale_none),
      outcome == "Postpartum haemorrhage" ~ scale_y_continuous(limits = c(0,0.02), oob = scales::rescale_none)
    )
  )
```

:::{custom-style="Caption"}
Figure 3. Incidence rates for Maternal Adverse Events across databases, stratified by age.
:::

```{r, fig.height=9}
tidyIncidence <- data$incidence |>
  dplyr::filter(strata_name %in% c("gestational_trimester", "maternal_age_group")) |>
  omopgenerics::filterAdditional(outcome_group %in% c("Maternal Adverse Events")) |>
  dplyr::mutate(
    group_level = factor(
      .data$group_level, 
      levels = c(aesiCode, maeCode), 
      labels = c(aesiClean, maeClean)
    ),
    group_level = as.character(group_level)
  ) |>
  dplyr::filter(!is.na(group_level)) |>
    dplyr::filter(group_level != "Maternal death") |>
  dplyr::filter(!(cdm_name == "CPRD GOLD" & group_level %in% excludeCPRD)) |>
  tidy() |>
  select(!c(
    "socioeconomic_status", "ethnicity", "birth_continent", "nationallity", "variable_name", "variable_level", "person_days_count"
  )) |>
  mutate(
    outcome_cohort_name = factor(.data$outcome_cohort_name, levels = maeClean),
    cdm_name = factor(cdm_name, dbOrder)
  ) |>
  arrange(cdm_name, outcome_cohort_name)

pAge <- pIncidence(tidyIncidence |> filter(gestational_trimester == "overall"), "maternal_age_group", "free_y", FALSE) +
  facet_wrap(vars(outcome_cohort_name), scales = "free_y") +
   ggh4x::facetted_pos_scales(
     y  = list(
       outcome_cohort_name == "Ectopic pregnancy" ~ scale_y_continuous(limits = c(0,3600), oob = scales::rescale_none),
       outcome_cohort_name == "Stillbirth" ~ scale_y_continuous(limits = c(0,36000), oob = scales::rescale_none),
       outcome_cohort_name == "Pre-eclampsia" ~ scale_y_continuous(limits = c(0, 50), oob = scales::rescale_none),
       outcome_cohort_name == "Eclampsia" ~ scale_y_continuous(limits = c(0,200), oob = scales::rescale_none),
       outcome_cohort_name == "HELLP" ~ scale_y_continuous(limits = c(0,3000), oob = scales::rescale_none),
       outcome_cohort_name == "Postpartum endometritis" ~ scale_y_continuous(limits = c(0,2000), oob = scales::rescale_none),
       outcome_cohort_name == "Postpartum haemorrhage" ~ scale_y_continuous(limits = c(0,7500), oob = scales::rescale_none)
     )
   ) 
pAge
```